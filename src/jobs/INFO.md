# Jobs (Фонові завдання)

## Призначення папки

Папка містить фонові завдання (cron jobs), які виконуються за розкладом для автоматизації процесів (оновлення статусів, перевірка дат, тощо).

## Структура

```
src/jobs/
└── statusScheduler.ts    # Планувальник для автоматичного оновлення статусів
```

## Файли

### statusScheduler.ts

**Призначення:** Планувальник (scheduler) для автоматичного оновлення статусів кімнат та проживань.

**Що робить:**

- Запускає `StatusService.tick()` за розкладом (cron)
- Контролюється через env змінні
- Підтримує зупинку/відновлення для graceful shutdown
- Захищений від перекриття виконання (skip якщо попередній tick ще виконується)
- Timezone-aware (використовує APP_TIMEZONE)

**Основні функції:**

1. **startStatusScheduler():**
   - Створює cron завдання
   - Автоматично запускає (якщо AUTO_START = true)
   - Idempotent (не створює дублікати)

2. **stopStatusScheduler():**
   - Зупиняє cron завдання
   - Використовується для graceful shutdown

3. **resumeStatusScheduler():**
   - Відновлює зупинене завдання

**Налаштування через ENV:**

- `STATUS_CRON` - cron вираз (за замовчуванням: `*/30 * * * * *` - кожні 30 секунд)
- `STATUS_AUTO_START` - автоматичний запуск (за замовчуванням: `true`)

**Приклади cron виразів:**

- `*/30 * * * * *` - кожні 30 секунд
- `* * * * *` - кожну хвилину
- `0 */5 * * * *` - кожні 5 хвилин

**Що виконує StatusService.tick():**

- Оновлює статуси кімнат на основі активних проживань
- Оновлює статуси проживань на основі дат
- Перевіряє застарілі бронювання

**Використання:**

```typescript
import { startStatusScheduler, stopStatusScheduler } from "./jobs/statusScheduler";

// При старті додатку
startStatusScheduler();

// При graceful shutdown
stopStatusScheduler();
```

**Інтеграція:**

- Викликається в `src/index.ts` при старті сервера
- Зупиняється при graceful shutdown (SIGINT, SIGTERM)

## Важливі моменти

- **Idempotent** - можна викликати startStatusScheduler() кілька разів без створення дублікатів
- **Захист від перекриття** - якщо попередній tick ще виконується, наступний пропускається
- **Graceful shutdown** - коректно зупиняється при завершенні додатку
- **Timezone-aware** - враховує часову зону додатку
- **Конфігурований** - всі налаштування через env змінні

## Майбутні jobs

Можуть бути додані інші фонові завдання:
- `emailScheduler.ts` - відправка email нотифікацій
- `cleanupScheduler.ts` - очищення старих логів
- `backupScheduler.ts` - резервне копіювання

---

**Останнє оновлення:** 2025-01-XX




