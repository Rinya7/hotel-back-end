# Middlewares (–ü—Ä–æ–º—ñ–∂–Ω–µ –ø—Ä–æ–≥—Ä–∞–º–Ω–µ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è)

## –©–æ —Ü–µ?
Middleware ‚Äî —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—ó, —è–∫—ñ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –º—ñ–∂ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è–º –∑–∞–ø–∏—Ç—É —ñ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ. –í–æ–Ω–∏ –º–æ–∂—É—Ç—å –æ–±—Ä–æ–±–ª—è—Ç–∏ –∑–∞–ø–∏—Ç–∏, –¥–æ–¥–∞–≤–∞—Ç–∏ –¥–∞–Ω—ñ, –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É —Ç–æ—â–æ.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```
src/middlewares/
‚îú‚îÄ‚îÄ authMiddleware.ts    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
‚îî‚îÄ‚îÄ INFO.md             # –¶–µ–π —Ñ–∞–π–ª
```

## –û—Å–Ω–æ–≤–Ω—ñ middleware

### authMiddleware.ts
**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:** –ü–µ—Ä–µ–≤—ñ—Ä—è—î JWT —Ç–æ–∫–µ–Ω —ñ –¥–æ–¥–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ –∑–∞–ø–∏—Ç—É.

**–Ø–∫ –ø—Ä–∞—Ü—é—î:**
1. –û—Ç—Ä–∏–º—É—î —Ç–æ–∫–µ–Ω –∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Authorization: Bearer <token>`
2. –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω—É
3. –î–µ–∫–æ–¥—É—î –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
4. –î–æ–¥–∞—î `req.user` –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
5. –ü–µ—Ä–µ–¥–∞—î —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É middleware/–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—É

**–ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:**
```typescript
// –í routes
router.get('/rooms', authMiddleware, getRooms);

// –í –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—ñ
export const getRooms = async (req: Request, res: Response) => {
  // req.user –º—ñ—Å—Ç–∏—Ç—å –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  const adminId = req.user.adminId;
  const role = req.user.role;
  // ...
};
```

**–î–∞–Ω—ñ –≤ req.user:**
```typescript
interface JwtUser {
  adminId: number; // ID –≤–ª–∞—Å–Ω–∏–∫–∞ –≥–æ—Ç–µ–ª—é (–¥–ª—è editor ‚Äî —Ü–µ id admin'–∞)
  role: 'superadmin' | 'admin' | 'editor';
  sub: number; // —Ñ–∞–∫—Ç–∏—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á, —è–∫–∏–π –∑–∞–ª–æ–≥—ñ–Ω–∏–≤—Å—è
}
```

**Middleware —Ñ—É–Ω–∫—Ü—ñ—ó:**
- **authenticateToken()** ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω—É —Ç–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è `req.user`
- **isSuperadmin()** ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î superadmin
- **isAdmin()** ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î admin (–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—é –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
- **isEditorOrAdmin()** ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î admin –∞–±–æ editor (–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—é –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
- **checkUserNotBlocked()** ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:
  - –î–ª—è –∞–¥–º—ñ–Ω–∞: –ø–µ—Ä–µ–≤—ñ—Ä—è—î `admin.isBlocked`
  - –î–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞: –ø–µ—Ä–µ–≤—ñ—Ä—è—î `editor.isBlocked` –∞–±–æ `editor.createdBy?.isBlocked`
  - –ü–æ–≤–µ—Ä—Ç–∞—î 403 –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º "–í–∞—à –∞–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ, –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–∏—Å—Ç–µ–º–∏"

## –í–±—É–¥–æ–≤–∞–Ω—ñ middleware

### express.json()
- –ü–∞—Ä—Å–∏—Ç—å JSON –∑ body –∑–∞–ø–∏—Ç—É
- –î–æ–¥–∞—î `req.body` –∑ –¥–∞–Ω–∏–º–∏

### cors()
- –û–±—Ä–æ–±–ª—è—î CORS –∑–∞–ø–∏—Ç–∏
- –î–æ–∑–≤–æ–ª—è—î –∑–∞–ø–∏—Ç–∏ –∑ frontend (http://localhost:5173)

### helmet()
- –î–æ–¥–∞—î –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–ø–µ–∫–∏
- –ó–∞—Ö–∏—â–∞—î –≤—ñ–¥ XSS, clickjacking —Ç–æ—â–æ

### rateLimit()
- –û–±–º–µ–∂—É—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤
- –ó–∞—Ö–∏—â–∞—î –≤—ñ–¥ DDoS –∞—Ç–∞–∫
- –û–∫—Ä–µ–º–∏–π –ª—ñ–º—ñ—Ç –¥–ª—è `/auth/login` (30 –∑–∞–ø–∏—Ç—ñ–≤/15 —Ö–≤)

## –ü–æ—Ä—è–¥–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
```typescript
// src/app.ts
app.use(helmet());           // 1. –ë–µ–∑–ø–µ–∫–∞
app.use(cors());            // 2. CORS
app.use(express.json());    // 3. –ü–∞—Ä—Å–∏–Ω–≥ JSON
app.use(rateLimit());       // 4. –õ—ñ–º—ñ—Ç–∏ –∑–∞–ø–∏—Ç—ñ–≤
// ... routes –∑ authMiddleware
```

## –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É

### Superadmin
- –î–æ—Å—Ç—É–ø –¥–æ –≤—Å—ñ—Ö endpoints
- –ú–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ admin'—ñ–≤
- –ë–∞—á–∏—Ç—å –≤—Å—ñ –∫—ñ–º–Ω–∞—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—ñ

### Admin
- –î–æ—Å—Ç—É–ø –¥–æ –∫—ñ–º–Ω–∞—Ç —Å–≤–æ–≥–æ –≥–æ—Ç–µ–ª—é
- –ú–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ editor'—ñ–≤
- –ö–µ—Ä—É—î –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è–º–∏

### Editor
- –¢—ñ–ª—å–∫–∏ –∑–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—ñ–≤ –∫—ñ–º–Ω–∞—Ç
- –†–æ–±–æ—Ç–∞ –∑ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è–º–∏
- –ù–ï –º–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤/–∫—ñ–º–Ω–∞—Ç–∏

## –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
```typescript
// –Ø–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π
if (!token || !isValidToken(token)) {
  return res.status(401).json({ message: 'Unauthorized' });
}

// –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π
if (user.isBlocked) {
  return res.status(403).json({ message: 'User is blocked' });
}
```

## –ü—Ä–∏–∫–ª–∞–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–æ–≥–æ middleware
```typescript
// middleware/logger.ts
export const loggerMiddleware = (req: Request, res: Response, next: NextFunction) => {
  console.log(`${req.method} ${req.path} - ${new Date().toISOString()}`);
  next(); // –í–∞–∂–ª–∏–≤–æ! –ü–µ—Ä–µ–¥–∞—Ç–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –¥–∞–ª—ñ
};

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
app.use(loggerMiddleware);
```

## –í–∞–∂–ª–∏–≤—ñ –º–æ–º–µ–Ω—Ç–∏
- **next()** ‚Äî –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
- **–ü–æ—Ä—è–¥–æ–∫** ‚Äî middleware –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –≤ –ø–æ—Ä—è–¥–∫—É –¥–æ–¥–∞–≤–∞–Ω–Ω—è
- **–ü–æ–º–∏–ª–∫–∏** ‚Äî –æ–±—Ä–æ–±–ª—è—Ç–∏ –≤ try-catch –±–ª–æ–∫–∞—Ö
- **–¢–æ–∫–µ–Ω–∏** ‚Äî –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –≤ –±–µ–∑–ø–µ—á–Ω–æ–º—É –º—ñ—Å—Ü—ñ
- **–ë–ª–æ–∫—É–≤–∞–Ω–Ω—è** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ `isAdmin()` —Ç–∞ `isEditorOrAdmin()`

## üìÖ –û—Å—Ç–∞–Ω–Ω—ñ –∑–º—ñ–Ω–∏ (2025-01-26)

### ‚úÖ –î–æ–¥–∞–Ω–æ:
- **checkUserNotBlocked()** ‚Äî middleware –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  - –ü–µ—Ä–µ–≤—ñ—Ä—è—î –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∞–¥–º—ñ–Ω–∞ (`admin.isBlocked`)
  - –ü–µ—Ä–µ–≤—ñ—Ä—è—î –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (`editor.isBlocked` –∞–±–æ `editor.createdBy?.isBlocked`)
  - –ü–æ–≤–µ—Ä—Ç–∞—î 403 –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é
- –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ `isAdmin()` —Ç–∞ `isEditorOrAdmin()`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø–∏—Ç—ñ

### üîß –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ:
- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –≤ `loginAdmin()` (—Ç–µ–ø–µ—Ä –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è —Å–∞–º —Ä–µ–¥–∞–∫—Ç–æ—Ä, –∞ –Ω–µ —Ç—ñ–ª—å–∫–∏ –π–æ–≥–æ —Å—Ç–≤–æ—Ä—é–≤–∞—á)
- –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –≤ middleware