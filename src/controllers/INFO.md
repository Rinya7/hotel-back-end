# Controllers (–û–±—Ä–æ–±–Ω–∏–∫–∏ –∑–∞–ø–∏—Ç—ñ–≤)

## –©–æ —Ü–µ?
–ö–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏ ‚Äî —Ü–µ –æ–±—Ä–æ–±–Ω–∏–∫–∏ HTTP –∑–∞–ø–∏—Ç—ñ–≤. –í–æ–Ω–∏ –æ—Ç—Ä–∏–º—É—é—Ç—å –∑–∞–ø–∏—Ç–∏ –≤—ñ–¥ –∫–ª—ñ—î–Ω—Ç–∞, –≤–∏–∫–ª–∏–∫–∞—é—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ —Å–µ—Ä–≤—ñ—Å–∏ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏, —ñ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞
```
src/controllers/
‚îú‚îÄ‚îÄ auth.controller.ts           # –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ç–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
‚îú‚îÄ‚îÄ roomController.ts           # –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∞–º–∏
‚îú‚îÄ‚îÄ roomAvailabilityController.ts # –î–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å –∫—ñ–º–Ω–∞—Ç
‚îú‚îÄ‚îÄ roomPolicy.controller.ts    # –ü–æ–ª—ñ—Ç–∏–∫–∏ –∫—ñ–º–Ω–∞—Ç
‚îú‚îÄ‚îÄ stayController.ts           # –ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è
‚îú‚îÄ‚îÄ stayOps.controller.ts       # –û–ø–µ—Ä–∞—Ü—ñ—ó –∑ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è–º–∏
‚îú‚îÄ‚îÄ stayQuery.controller.ts     # –ó–∞–ø–∏—Ç–∏ –ø–æ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è—Ö
‚îú‚îÄ‚îÄ guest.controller.ts         # –ì–æ—Å—Ç—å–æ–≤–∏–π –¥–æ—Å—Ç—É–ø (—Ç–æ–∫–µ–Ω–∏ —Ç–∞ –ø–µ—Ä–µ–≥–ª—è–¥ –¥–∞–Ω–∏—Ö)
‚îî‚îÄ‚îÄ audit.controller.ts        # –ê—É–¥–∏—Ç –ª–æ–≥—ñ–≤
```

## –û—Å–Ω–æ–≤–Ω—ñ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∏

### auth.controller.ts
- **login()** ‚Äî –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- **createAdmin()** ‚Äî —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–¥–º—ñ–Ω–∞ (—Ç—ñ–ª—å–∫–∏ superadmin)
- **createEditor()** ‚Äî —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ (—Ç—ñ–ª—å–∫–∏ admin)
- **getUsers()** ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- **blockUser()** / **unblockUser()** ‚Äî –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
- **deleteUser()** ‚Äî –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

### roomController.ts
- **getAllRooms()** ‚Äî –≤—Å—ñ –∫—ñ–º–Ω–∞—Ç–∏ (superadmin)
- **getRooms()** ‚Äî –∫—ñ–º–Ω–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≥–æ—Ç–µ–ª—é
- **createRoom()** ‚Äî —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏
- **updateRoom()** ‚Äî —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏
- **deleteRoom()** ‚Äî –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏
- **updateRoomStatus()** ‚Äî –∑–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É –∫—ñ–º–Ω–∞—Ç–∏

### stayController.ts
- **getStaysByRoom()** ‚Äî —ñ—Å—Ç–æ—Ä—ñ—è –ø—Ä–æ–∂–∏–≤–∞–Ω—å –∫—ñ–º–Ω–∞—Ç–∏
- **createStay()** ‚Äî —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è/–∑–∞—Å–µ–ª–µ–Ω–Ω—è
- **closeStay()** ‚Äî –∑–∞–∫—Ä–∏—Ç—Ç—è –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è

### guest.controller.ts
- **createGuestAccessLink()** ‚Äî —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è/–æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—É –¥–æ—Å—Ç—É–ø—É –¥–ª—è –≥–æ—Å—Ç—è (POST /guest/stays/:stayId/link)
- **getGuestAccessByToken()** ‚Äî –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –ø–æ —Ç–æ–∫–µ–Ω—É (GET /guest/access/:token)

## –Ø–∫ –ø—Ä–∞—Ü—é—î?
1. **–û—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É** ‚Äî Express –ø–µ—Ä–µ–¥–∞—î –∑–∞–ø–∏—Ç –≤ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä
2. **–í–∞–ª—ñ–¥–∞—Ü—ñ—è** ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ OpenAPI –≤–∞–ª—ñ–¥–∞—Ç–æ—Ä
3. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è** ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ —á–µ—Ä–µ–∑ authMiddleware
4. **–ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞** ‚Äî –≤–∏–∫–ª–∏–∫ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É
5. **–í—ñ–¥–ø–æ–≤—ñ–¥—å** ‚Äî –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –∫–ª—ñ—î–Ω—Ç—É

## –ü—Ä–∏–∫–ª–∞–¥
```typescript
// roomController.ts
export const createRoom = async (req: Request, res: Response) => {
  try {
    // 1. –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ –∑–∞–ø–∏—Ç—É (–≤–∂–µ –≤–∞–ª—ñ–¥–æ–≤–∞–Ω—ñ)
    const roomData = req.body;
    
    // 2. –í–∏–∫–ª–∏–∫–∞—î–º–æ —Å–µ—Ä–≤—ñ—Å
    const room = await roomService.createRoom(roomData, req.user.adminId);
    
    // 3. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    res.status(201).json({
      message: '–ö—ñ–º–Ω–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞',
      room
    });
  } catch (error) {
    // 4. –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
    res.status(400).json({ message: error.message });
  }
};
```

## –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É
- **superadmin** ‚Äî –¥–æ—Å—Ç—É–ø –¥–æ –≤—Å—ñ—Ö –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—ñ–≤
- **admin** ‚Äî –¥–æ—Å—Ç—É–ø –¥–æ –∫—ñ–º–Ω–∞—Ç —Ç–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —Å–≤–æ–≥–æ –≥–æ—Ç–µ–ª—é
- **editor** ‚Äî —Ç—ñ–ª—å–∫–∏ –∑–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—ñ–≤ —Ç–∞ —Ä–æ–±–æ—Ç–∞ –∑ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è–º–∏
- **guest** ‚Äî –¥–æ—Å—Ç—É–ø —Ç—ñ–ª—å–∫–∏ —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø—É (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó)

---

## –•—ñ–¥ —Ä–æ–±–æ—Ç–∏ (Guest —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å)

### ‚úÖ –í–ò–ö–û–ù–ê–ù–û:

**–ï—Ç–∞–ø 1-2 (–ß–∞—Å—Ç–∏–Ω–∞):**
- ‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ entity `GuestAccessToken` (src/entities/GuestAccessToken.ts)
  - –ü–æ–ª—è: id, stay, token, createdAt, updatedAt, expiresAt, revokedAt, lastUsedAt
  - –ó–≤'—è–∑–æ–∫ ManyToOne –∑ Stay
- ‚úÖ –î–æ–¥–∞–Ω–æ –∑–≤'—è–∑–æ–∫ Stay ‚Üî GuestAccessToken (OneToMany/ManyToOne –≤ Stay.ts)
- ‚úÖ –í–∏–Ω–µ—Å–µ–Ω–æ —Ç–∏–ø–∏ –≤ src/types/guest.ts:
  - `GuestStayStatus` ‚Äî —Ç–∏–ø —Å—Ç–∞—Ç—É—Å—É –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è
  - `GuestStayView` ‚Äî DTO –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≥–æ—Å—Ç—é
  - `GenerateTokenResponse` ‚Äî –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ç–æ–∫–µ–Ω—É
  - `GuestAccessErrorResponse` ‚Äî —Ç–∏–ø –¥–ª—è –ø–æ–º–∏–ª–æ–∫ –¥–æ—Å—Ç—É–ø—É
- ‚úÖ –í–∏–∑–Ω–∞—á–µ–Ω–æ –ª–æ–≥—ñ–∫—É —Ä—ñ–≤–Ω—ñ–≤ –¥–æ—Å—Ç—É–ø—É –∑–∞ —Å—Ç–∞—Ç—É—Å–∞–º–∏ Stay (booked, occupied, completed, cancelled)

**–ï—Ç–∞–ø 2 (–†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–µ–∫–µ–Ω–¥–∞):**
- ‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä `guest.controller.ts`:
  - `createGuestAccessLink()` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ç–æ–∫–µ–Ω—É –¥–ª—è Stay (–∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –ø—Ä–∞–≤ admin/editor)
  - `getGuestAccessByToken()` ‚Äî –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è –ø–æ —Ç–æ–∫–µ–Ω—É (–ø—É–±–ª—ñ—á–Ω–∏–π –µ–Ω–¥–ø–æ—ñ–Ω—Ç)
  - `generateSecureToken()` ‚Äî –±–µ–∑–ø–µ—á–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ç–æ–∫–µ–Ω—ñ–≤ —á–µ—Ä–µ–∑ crypto.randomBytes
  - `mapStayToGuestView()` ‚Äî –º–∞–ø–ø—ñ–Ω–≥ Stay+Room+Admin ‚Üí GuestStayView
  - `formatHotelAddress()` ‚Äî —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –∞–¥—Ä–µ—Å–∏ –≥–æ—Ç–µ–ª—é
  - `formatPhoneNumber()` ‚Äî —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —Ç–µ–ª–µ—Ñ–æ–Ω—É
- ‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ —Ä–æ—É—Ç–∏ `guest.routes.ts`:
  - POST `/guest/stays/:stayId/link` (–∑ authMiddleware, isEditorOrAdmin)
  - GET `/guest/access/:token` (–ø—É–±–ª—ñ—á–Ω–∏–π, –±–µ–∑ auth)
- ‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ —Ä–æ—É—Ç–∏ –≤ app.ts
- ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ —ñ–º–ø–æ—Ä—Ç–∏ (authMiddleware, AppDataSource)
- ‚úÖ –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –ª–æ–≥—ñ–∫—É –ø–æ–∫–∞–∑—É Wi-Fi —Ç—ñ–ª—å–∫–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å—É `occupied`
- ‚úÖ –î–æ–¥–∞–Ω–æ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é —Ç–æ–∫–µ–Ω—ñ–≤ (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ expiresAt, revokedAt)
- ‚úÖ –î–æ–¥–∞–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è lastUsedAt –ø—Ä–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ —Ç–æ–∫–µ–Ω—É

### üìã –ó–ê–õ–ò–®–ò–õ–û–°–¨:

**–ï—Ç–∞–ø 3 (–§—Ä–æ–Ω—Ç–µ–Ω–¥ PWA):**
- ‚è≥ –ü—Ä–æ—î–∫—Ç—É–≤–∞–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Å—Ç–æ—Ä—ñ–Ω–æ–∫ —Ç–∞ —Ä–æ—É—Ç—ñ–≤ Vue
- ‚è≥ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –µ–∫—Ä–∞–Ω—ñ–≤ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Å—Ç–∞—Ç—É—Å—ñ–≤ Stay
- ‚è≥ –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ –±–µ–∫–µ–Ω–¥ API

**–ï—Ç–∞–ø 4 (–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó):**
- ‚è≥ POST `/guest/access/:token/requests/cleaning` ‚Äî –∑–∞–ø–∏—Ç –Ω–∞ –ø—Ä–∏–±–∏—Ä–∞–Ω–Ω—è
- ‚è≥ POST `/guest/access/:token/feedback` ‚Äî –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫
- ‚è≥ POST `/guest/access/:token/extend` ‚Äî –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è
- ‚è≥ –î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ/–ø–æ–±–∞–∂–∞–Ω–Ω—è –≥–æ—Å—Ç—è (–≤ –º–∞–π–±—É—Ç–Ω—å–æ–º—É)

**–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:**
- ‚è≥ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é —Ç–æ–∫–µ–Ω—ñ–≤
- ‚è≥ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–æ—Å—Ç—É–ø –ø–æ —Ç–æ–∫–µ–Ω—É –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Å—Ç–∞—Ç—É—Å—ñ–≤ Stay
- ‚è≥ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É (Wi-Fi —Ç—ñ–ª—å–∫–∏ –¥–ª—è occupied)
- ‚è≥ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é —Ç–æ–∫–µ–Ω—ñ–≤ (–ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ, –≤—ñ–¥–∫–ª–∏–∫–∞–Ω—ñ)
- ‚è≥ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É (admin/editor –º–æ–∂—É—Ç—å –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Ç–æ–∫–µ–Ω–∏)

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è:**
- ‚è≥ –î–æ–¥–∞—Ç–∏ OpenAPI —Å—Ö–µ–º–∏ –¥–ª—è guest endpoints
- ‚è≥ –û–Ω–æ–≤–∏—Ç–∏ Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é