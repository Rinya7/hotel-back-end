# Migrations (Міграції бази даних)

## Призначення папки

Папка містить міграції бази даних - SQL скрипти для створення та зміни структури таблиць. Міграції дозволяють версіонувати схему БД та застосовувати зміни послідовно.

## Структура

```
src/migrations/
├── 1754930036124-init_schema.ts              # Початкова схема БД
├── 1754930036125-fix_room_unique.ts          # Виправлення унікальності кімнат
├── 1754930036130-add_timestamps.ts           # Додавання timestamps
├── 1754930036131-room-unique-by-admin.ts     # Унікальність кімнат по адміну
├── 1754930036132_add_policy_hours_to_admin.ts # Політики годин для адміна
├── 1756372174656-AddRoomPolicyHours.ts       # Політики годин для кімнат
├── 1760436439954-init_schema.ts              # Оновлена початкова схема
├── 1762108621642-UpdateAddressToDetailedFields.ts # Детальна адреса
├── 1763000000000-AddAuditFieldsAndLogTables.ts   # Аудит поля та таблиці
├── 1763001000000-AddCommentToStatusLogs.ts  # Коментарі в логах статусів
├── 1763002000000-AddRoomCleaningLog.ts       # Логи прибирання кімнат
├── 1763002002000-ExtendRoomStatusEnum.ts    # Розширення enum статусів кімнат
├── 1763002003000-RemoveBookedFromRoomStatusEnum.ts # Видалення booked з enum
└── 1763002004000-CreateStayGuests.ts         # Таблиця деталей гостей
```

## Як працюють міграції

### Формат імені файлу

```
<TIMESTAMP>-<Description>.ts
```

- **TIMESTAMP** - унікальний timestamp для порядку виконання
- **Description** - опис зміни (латинськими літерами)

### Структура міграції

```typescript
import { MigrationInterface, QueryRunner } from "typeorm";

export class MigrationName1234567890 implements MigrationInterface {
  // Виконання міграції (вперед)
  public async up(queryRunner: QueryRunner): Promise<void> {
    // SQL команди для застосування змін
  }

  // Відкат міграції (назад)
  public async down(queryRunner: QueryRunner): Promise<void> {
    // SQL команди для відкату змін
  }
}
```

## Основні міграції

### init_schema.ts

**Призначення:** Створення початкової схеми БД (таблиці, індекси, foreign keys).

**Що створює:**

- Таблиця `admin` - користувачі системи
- Таблиця `room` - кімнати готелів
- Таблиця `stay` - проживання
- Зв'язки між таблицями
- Індекси для оптимізації

### fix_room_unique.ts

**Призначення:** Виправлення унікальності номерів кімнат.

**Що робить:**

- Додає unique constraint на roomNumber + adminId

### add_timestamps.ts

**Призначення:** Додавання полів createdAt та updatedAt до таблиць.

**Що робить:**

- Додає timestamps до всіх основних таблиць

### AddAuditFieldsAndLogTables.ts

**Призначення:** Додавання аудит полів та таблиць логів.

**Що створює:**

- Поля `createdBy`, `updatedBy`, `updatedByRole` в таблицях
- Таблиця `stay_status_log` - логи змін статусів проживань
- Таблиця `room_status_log` - логи змін статусів кімнат

### AddRoomCleaningLog.ts

**Призначення:** Створення таблиці логів прибирання кімнат.

**Що створює:**

- Таблиця `room_cleaning_log` - історія прибирання кімнат

### CreateStayGuests.ts

**Призначення:** Створення таблиці детальної інформації про гостей.

**Що створює:**

- Таблиця `stay_guest` - детальна інформація про кожного гостя (документи, дата народження, тощо)

## Команди для роботи з міграціями

### Застосувати міграції

```bash
npm run db:migrate
```

### Відкатити останню міграцію

```bash
npm run db:revert
```

### Згенерувати нову міграцію

```bash
npm run db:gen:init
```

**Важливо:** Спочатку змінити entities, потім генерувати міграцію.

## Важливі моменти

- **Порядок виконання** - міграції виконуються послідовно за timestamp
- **Не змінювати існуючі міграції** - завжди створювати нову
- **Тестувати down()** - переконатися, що відкат працює
- **Backup перед міграцією** - в production завжди робити backup
- **Атомарність** - кожна міграція має бути атомарною (або все, або нічого)

## Створення нової міграції

1. Змінити entities (додати/змінити поля)
2. Запустити `npm run db:gen:init` - згенерує міграцію
3. Перевірити згенерований код
4. Застосувати `npm run db:migrate`
5. Перевірити результат в БД

---

**Останнє оновлення:** 2025-01-XX




